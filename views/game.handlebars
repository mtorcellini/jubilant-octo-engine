<h1>Â¡game!</h1>

<div id="gameboard">
  <table>
    <tbody> 
      <tr class="row1" data="1">
        <td class="col1" data="1"></td>
        <td class="col2" data="2"></td>
        <td class="col3" data="3"></td>
      </tr>
      <tr class="row2" data="2">
        <td class="col1" data="1"></td>
        <td class="col2" data="2"></td>
        <td class="col3" data="3"></td>
      </tr>
      <tr class="row3" data="3">
        <td class="col1" data="1"></td>
        <td class="col2" data="2"></td>
        <td class="col3" data="3"></td>
      </tr>
    </tbody>
  </table>
</div>

<p id="coords"></p>

<button class="piecePicker" id="chooseX" data="x">X</button>
<button class="piecePicker" id="chooseO" data="o">O</button>

<p id="gamepiece"></p>

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"></script>

<script>
  $(document).ready(() => {

    // function to get game data, run on page load, run every 5 seconds?
    const getGameData = async () => {
      fetch(`/api/game/${id}`)
      .then(data => data.json())
      .then(data => {
        if (data.state.hasOwnProperty("x")) {
          console.log(data);
          gameState = data.state;
          markSquares(data);
        }
      })
    }

    // mark the game squares with each player's pieces
    const markSquares = (data) => {
      const xmarks = data.state.x;
      if (xmarks) {
        xmarks.forEach(xmark => {
          const xCoord = xmark[0];
          const yCoord = xmark[1];
          $(`.row${yCoord} .col${xCoord}`).css({background : "darkblue", color: "white"}).text("X");
        });
      }

      const omarks = data.state.o;
      if (omarks) {
        omarks.forEach(omark => {
          const xCoord = omark[0];
          const yCoord = omark[1];
          $(`.row${yCoord} .col${xCoord}`).css({background : "purple", color: "white"}).text("O");
        });
      }
    }

    const makeMove = async () => {
      console.log('makeMove');
      console.log('gamestate', gameState);

      // send player ID, click coordinates
      return fetch(`/api/game/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body : JSON.stringify(gameState)
      })
    }


    const id = 1; // test id 1
    getGameData();

    // initialize game state
    let gameState = {
      x : [],
      o : []
    };

    // initialize player x or o 
    let playerPiece = '';

    // add listener to piece picker
    $('.piecePicker').on('click', function () {
      playerPiece = $(this).attr("data");
      console.log(playerPiece);

      // hide buttons and display confirmation message
      $('.piecePicker').hide();
      $('#gamepiece').text(`You're playing as '${playerPiece}'`);
    })


    // click listener on gameboard
    $("#gameboard").on("click", async (event) => {
      try {
        const xcoord = parseInt(event.target.getAttribute("data"));
        const ycoord = parseInt(event.target.parentElement.getAttribute("data"));
        const coords = [xcoord, ycoord];
        console.log(coords);

        // update gameState with new move
        gameState[playerPiece].push(coords);
        
        $("#coords").text("You clicked on: " + coords);
        console.log(gameState);


        $(event.target).css({background : "black"});


        await makeMove();

      } catch (err) {
        console.log(err);
      }
    })

    const getTimer = setInterval(getGameData, 1000);



});
</script>